<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vesikalık Fotoğraf</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .guide-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 35mm;
            height: 45mm;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="max-w-4xl mx-auto p-4">
        <!-- Camera View -->
        <div id="cameraContainer" class="mb-4">
            <input type="text" id="photoName" placeholder="Fotoğraf İsmi" class="w-full mb-4 p-2 border rounded">
            <div class="relative">
                <video id="video" class="w-full h-auto" autoplay playsinline></video>
                <div class="guide-overlay"></div>
            </div>
            <button id="captureBtn" class="w-16 h-16 rounded-full bg-red-500 hover:bg-red-600 mx-auto block mt-4"></button>
        </div>

        <!-- Gallery -->
        <div id="gallery" class="mt-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Galeri</h2>
                <div class="space-x-2">
                    <button id="deleteAllBtn" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Tümünü Sil</button>
                    <button id="downloadBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">İndir</button>
                    <button id="shareBtn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 hidden sm:inline-block">Paylaş</button>
                </div>
            </div>
            <div id="photoGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
        </div>
    </div>

    <script>
        // Storage Manager
        const StorageManager = {
            MAX_PHOTOS: 50,
            
            async savePhoto(name, blob) {
                const photos = this.getPhotos();
                if (photos.length >= this.MAX_PHOTOS) {
                    throw new Error('Maksimum fotoğraf limitine ulaşıldı');
                }
                
                const reader = new FileReader();
                return new Promise((resolve, reject) => {
                    reader.onloadend = () => {
                        const photoData = {
                            id: Date.now(),
                            name: name || `Fotoğraf ${photos.length + 1}`,
                            data: reader.result,
                            brightness: 100,
                            sharpness: 100
                        };
                        photos.push(photoData);
                        localStorage.setItem('photos', JSON.stringify(photos));
                        resolve(photoData);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            },

            getPhotos() {
                return JSON.parse(localStorage.getItem('photos') || '[]');
            },

            deletePhoto(id) {
                const photos = this.getPhotos().filter(photo => photo.id !== id);
                localStorage.setItem('photos', JSON.stringify(photos));
            },

            deleteAllPhotos() {
                localStorage.removeItem('photos');
            },

            updatePhoto(id, updates) {
                const photos = this.getPhotos();
                const index = photos.findIndex(photo => photo.id === id);
                if (index !== -1) {
                    photos[index] = { ...photos[index], ...updates };
                    localStorage.setItem('photos', JSON.stringify(photos));
                }
            }
        };

        // Camera Manager
        const CameraManager = {
            video: document.getElementById('video'),
            stream: null,

            async init() {
                const constraints = {
                    video: {
                        facingMode: this.isMobile() ? 'environment' : 'user',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };

                try {
                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.stream;
                } catch (err) {
                    console.error('Kamera erişimi hatası:', err);
                    alert('Kamera erişimi sağlanamadı');
                }
            },

            isMobile() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            },

            capturePhoto() {
                const canvas = document.createElement('canvas');
                // 35x45mm at 300 DPI
                canvas.width = 413;
                canvas.height = 531;
                const ctx = canvas.getContext('2d');

                // Calculate crop dimensions
                const videoAspect = this.video.videoWidth / this.video.videoHeight;
                const targetAspect = 35/45;
                
                let cropWidth = this.video.videoWidth;
                let cropHeight = cropWidth / targetAspect;
                
                if (cropHeight > this.video.videoHeight) {
                    cropHeight = this.video.videoHeight;
                    cropWidth = cropHeight * targetAspect;
                }

                const x = (this.video.videoWidth - cropWidth) / 2;
                const y = (this.video.videoHeight - cropHeight) / 2;

                ctx.drawImage(this.video, x, y, cropWidth, cropHeight, 0, 0, canvas.width, canvas.height);

                return new Promise((resolve) => {
                    canvas.toBlob(resolve, 'image/jpeg', 0.95);
                });
            },

            stop() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }
            }
        };

        // Gallery Manager
        const GalleryManager = {
            photoGrid: document.getElementById('photoGrid'),

            renderPhotos() {
                const photos = StorageManager.getPhotos();
                this.photoGrid.innerHTML = photos.map(photo => this.createPhotoElement(photo)).join('');
                this.attachPhotoListeners();
            },

            createPhotoElement(photo) {
                return `
                    <div class="relative group" data-id="${photo.id}">
                        <img src="${photo.data}" alt="${photo.name}" class="w-full h-auto rounded">
                        <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="absolute bottom-0 left-0 right-0 p-2">
                                <input type="text" value="${photo.name}" class="photo-name w-full mb-2 p-1 text-sm">
                                <div class="flex space-x-2 mb-2">
                                    <input type="range" min="0" max="200" value="${photo.brightness}" class="brightness-slider">
                                    <input type="range" min="0" max="200" value="${photo.sharpness}" class="sharpness-slider">
                                </div>
                                <button class="delete-photo w-full bg-red-500 text-white py-1 rounded text-sm">Sil</button>
                            </div>
                        </div>
                    </div>
                `;
            },

            attachPhotoListeners() {
                // Name change listeners
                document.querySelectorAll('.photo-name').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const id = parseInt(e.target.closest('[data-id]').dataset.id);
                        StorageManager.updatePhoto(id, { name: e.target.value });
                    });
                });

                // Delete button listeners
                document.querySelectorAll('.delete-photo').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = parseInt(e.target.closest('[data-id]').dataset.id);
                        StorageManager.deletePhoto(id);
                        this.renderPhotos();
                    });
                });

                // Slider listeners
                document.querySelectorAll('.brightness-slider, .sharpness-slider').forEach(slider => {
                    slider.addEventListener('change', (e) => {
                        const id = parseInt(e.target.closest('[data-id]').dataset.id);
                        const updates = {};
                        if (slider.classList.contains('brightness-slider')) {
                            updates.brightness = parseInt(e.target.value);
                        } else {
                            updates.sharpness = parseInt(e.target.value);
                        }
                        StorageManager.updatePhoto(id, updates);
                    });
                });
            },

            async downloadPhotos() {
                const photos = StorageManager.getPhotos();
                if (photos.length === 0) return;

                if (photos.length === 1) {
                    const link = document.createElement('a');
                    link.href = photos[0].data;
                    link.download = `${photos[0].name}.jpg`;
                    link.click();
                    return;
                }

                const zip = new JSZip();
                photos.forEach(photo => {
                    const base64Data = photo.data.split(',')[1];
                    zip.file(`${photo.name}.jpg`, base64Data, {base64: true});
                });

                const content = await zip.generateAsync({type: 'blob'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = 'vesikalik_fotograf.zip';
                link.click();
            },

            async sharePhotos() {
                if (!navigator.share) {
                    alert('Paylaşım özelliği bu cihazda desteklenmiyor');
                    return;
                }

                const photos = StorageManager.getPhotos();
                if (photos.length === 0) return;

                try {
                    const zip = new JSZip();
                    photos.forEach(photo => {
                        const base64Data = photo.data.split(',')[1];
                        zip.file(`${photo.name}.jpg`, base64Data, {base64: true});
                    });

                    const content = await zip.generateAsync({type: 'blob'});
                    const file = new File([content], 'vesikalik_fotograf.zip', {
                        type: 'application/zip'
                    });

                    await navigator.share({
                        files: [file],
                        title: 'Vesikalık Fotoğraflar',
                    });
                } catch (err) {
                    console.error('Paylaşım hatası:', err);
                    alert('Paylaşım sırasında bir hata oluştu');
                }
            }
        };

        // Main App
        async function initApp() {
            await CameraManager.init();
            GalleryManager.renderPhotos();

            // Event Listeners
            document.getElementById('captureBtn').addEventListener('click', async () => {
                const blob = await CameraManager.capturePhoto();
                const name = document.getElementById('photoName').value;
                await StorageManager.savePhoto(name, blob);
                GalleryManager.renderPhotos();
            });

            document.getElementById('deleteAllBtn').addEventListener('click', () => {
                if (confirm('Tüm fotoğrafları silmek istediğinizden emin misiniz?')) {
                    StorageManager.deleteAllPhotos();
                    GalleryManager.renderPhotos();
                }
            });

            document.getElementById('downloadBtn').addEventListener('click', () => {
                GalleryManager.downloadPhotos();
            });

            document.getElementById('shareBtn').addEventListener('click', () => {
                GalleryManager.sharePhotos();
            });
        }

        initApp();
    </script>
</body>
</html>
